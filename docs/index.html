<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>talea - isole di calore di Bologna</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body, html { height: 100%; margin: 0; }
    header {
      background-color: #343a40;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }
    #map { position: absolute; top: 60px; bottom: 0; width: 100%; }
    .controls {
      position: absolute;
      top: 70px;
      left: 10px;
      background: white;
      padding: 1em;
      z-index: 1;
      border-radius: 0.5em;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      max-width: 300px;
    }
    .legend {
      margin-top: 10px;
    }
    .legend-color {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <header>Talea - isole di calore di Bologna</header>
  <div id="map"></div>
  <div class="controls">
    <div class="mb-2">
      I dati sono calcolati dai satelliti Landsat e Modis per l'estate 2024
      <label for="layerSelect" class="form-label">Scegli il layer:</label>
      <select class="form-select" id="layerSelect">
        <option value="">-- Nessuno --</option>
        <option value="z_score_class">Z-Score</option>
        <option value="ndvi_class">NDVI</option>
        <option value="albedo_class">Albedo</option>
        <option value="heat_ret_class">Heat Retention</option>
        <option value="heat_veg_class">Heat Vegetation</option>
        <option value="uhei_class">UHEI</option>
        <option value="delta_lst_class">Delta LST</option>
      </select>
    </div>
    <div class="mb-2">
      <label for="opacityRange" class="form-label">Trasparenza:</label>
      <input type="range" class="form-range" id="opacityRange" min="0" max="1" step="0.05" value="0.8">
    </div>
    <div class="mb-2">
      <label class="form-label">Sfondo:</label><br />
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="basemap" value="osm" checked>
        <label class="form-check-label">OpenStreetMap</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="basemap" value="ortofoto">
        <label class="form-check-label">Ortofoto Bologna 2024</label>
      </div>
    </div>
    <div id="legend" class="legend"></div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          osm: {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            tileSize: 256,
            attribution: '© OpenStreetMap contributors'
          },
          ortofoto: {
            type: 'raster',
            tiles: ['https://sitmappe.comune.bologna.it/tms/tileserver/Ortofoto2024/{z}/{x}/{y}.png'],
            tileSize: 256,
            attribution: '© Comune di Bologna, 2024'
          }
        },
        layers: [{ id: 'base-osm', type: 'raster', source: 'osm' }]
      },
      center: [11.34, 44.49],
      zoom: 13
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    map.addControl(new maplibregl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true
    }), 'top-right');

    const layerColors = {
      z_score_class: ["#313695", "#4575b4", "#74add1", "#abd9e9", "#e0f3f8", "#fee090", "#fdae61", "#f46d43", "#d73027", "#a50026"],
      ndvi_class: ["#ffffcc", "#c2e699", "#78c679", "#006837"],
      albedo_class: ["#ffffff", "#cccccc", "#999999", "#000000"],
      heat_ret_class: ["#ffffe0", "#ffe08c", "#ffc04d", "#ff9933", "#ff6600", "#cc0000", "#800000"],
      heat_veg_class: ["#ffffcc", "#ffeda0", "#feb24c", "#f03b20"],
      uhei_class: ["#ffffcc", "#ffeda0", "#fd8d3c", "#bd0026"],
      delta_lst_class: ["#30123b", "#4662d8", "#35abf8", "#1be5b5", "#74fe5d", "#c9ef34", "#fbb938", "#f56918", "#c92903", "#7a0403"]
    };

    const layerDescriptions = {
      z_score_class: { title: "Indice di deviazione (Z-Score)", description: "Indica quanto una zona si discosta dalla media delle temperature urbane.", labels: ["Molto più fredda", "Più fredda", "Fredda", "Leggermente fredda", "Nella media", "Leggermente calda", "Calda", "Più calda", "Molto calda", "Estremamente calda"] },
      ndvi_class: { title: "Indice di vegetazione NDVI", description: "Misura la quantità di vegetazione presente (valori alti = più verde).", labels: ["Assente", "Poca", "Media", "Molta"] },
      albedo_class: { title: "Albedo Superficiale", description: "Misura la riflettanza della superficie: bianco riflette, nero assorbe calore.", labels: ["Molto riflettente", "Riflettente", "Assorbente", "Molto assorbente"] },
      heat_ret_class: { title: "Accumulo di calore", description: "Indica quanto una superficie trattiene calore nel tempo.", labels: ["Molto bassa", "Bassa", "Moderata", "Media", "Alta", "Molto alta", "Estrema"] },
      heat_veg_class: { title: "Effetto vegetazione sul calore", description: "Effetto mitigante della vegetazione sulle temperature urbane.", labels: ["Basso", "Moderato", "Alto", "Molto alto"] },
      uhei_class: { title: "Indice UHEI", description: "Classificazione dell'intensità dell'isola di calore urbana.", labels: ["Bassa", "Media", "Alta", "Molto alta"] },
      delta_lst_class: { title: "Differenza LST Giorno/Notte", description: "Variazione della temperatura superficiale tra giorno e notte.", labels: ["Freddo notte", "Meno caldo", "Neutro", "Leggero caldo", "Moderato caldo", "Caldo", "Abbastanza caldo", "Molto caldo", "Estremo", "Estremamente caldo"] }
    };

    let currentLayer = null;

    document.getElementById('layerSelect').addEventListener('change', async function () {
      if (currentLayer) {
        if (map.getLayer(currentLayer)) map.removeLayer(currentLayer);
        if (map.getSource(currentLayer)) map.removeSource(currentLayer);
        document.getElementById('legend').innerHTML = '';
        currentLayer = null;
      }
      const layer = this.value;
      if (!layer) return;

      try {
        const response = await fetch(`topojson/${layer}.topojson`);
        const topo = await response.json();
        const geojson = topojson.feature(topo, topo.objects[Object.keys(topo.objects)[0]]);
        const colors = layerColors[layer];

        map.addSource(layer, { type: 'geojson', data: geojson });
        map.addLayer({
          id: layer,
          type: 'fill',
          source: layer,
          paint: {
            'fill-color': ['match', ['get', 'class'], ...colors.flatMap((c, i) => [i, c]), '#000000'],
            'fill-opacity': parseFloat(document.getElementById('opacityRange').value)
          }
        });

        currentLayer = layer;
        drawLegend(layer);
      } catch (err) {
        alert(`Errore nel caricamento del layer: ${err}`);
      }
    });

    document.getElementById('opacityRange').addEventListener('input', function () {
      if (currentLayer) {
        map.setPaintProperty(currentLayer, 'fill-opacity', parseFloat(this.value));
      }
    });

    document.querySelectorAll('input[name="basemap"]').forEach(r => {
      r.addEventListener('change', function () {
        const isOSM = this.value === 'osm';
        map.setLayoutProperty('base-osm', 'visibility', isOSM ? 'visible' : 'none');
        if (!map.getLayer('base-ortofoto')) {
          map.addLayer({ id: 'base-ortofoto', type: 'raster', source: 'ortofoto' });
        }
        map.setLayoutProperty('base-ortofoto', 'visibility', isOSM ? 'none' : 'visible');
      });
    });

    function drawLegend(layerId) {
      const legend = document.getElementById('legend');
      legend.innerHTML = '';
      const { title, description, labels } = layerDescriptions[layerId];
      const colors = layerColors[layerId];

      const titleEl = document.createElement('strong');
      titleEl.innerText = title;
      legend.appendChild(titleEl);

      const descEl = document.createElement('div');
      descEl.classList.add('mb-2');
      descEl.innerText = description;
      legend.appendChild(descEl);

      colors.forEach((color, i) => {
        const div = document.createElement('div');
        div.innerHTML = `<span class='legend-color' style='background:${color}'></span>${labels[i] || 'Classe ' + i}`;
        legend.appendChild(div);
      });
    }
  </script>
</body>
</html>
